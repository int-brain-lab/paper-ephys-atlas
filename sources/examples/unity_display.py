
##
# needs unityneuro cf. https://github.com/VirtualBrainLab/Urchin/tree/main/Examples/gallery
import numpy as np
import unityneuro.render as urn
urn.setup()
# urn.load_cosmos_areas()


def send2unity(values_dict):
    urn.clear()
    urn.clear_areas()
    urn.set_area_colormap("cool")
    # urn.load_beryl_areas()


    urn.set_area_intensity(values_dict)
    urn.set_area_visibility({k: True for k in values_dict})
    urn.set_area_material({k: "transparent-lit" for k in values_dict})
    urn.set_area_alpha({k: .4 for k in values_dict})


acronyms = ['VISa', 'CA1', 'DG', 'LP', 'PO']
values_dict = {k: np.random.rand() for k in acronyms}
send2unity(values_dict)

values_dict = {
    'IC': 0.10411464783722249,
 'PSV': 0.10097288851582877,
 'IF': 0.09815304259776564,
 'PT': 0.15912494683337944,
 'IG': 0.08810167123649736,
 'AAA': 0.15055883327491362,
 'IGL': 0.15444379429735866,
 'III': 0.03456465969943567,
 'PVH': 0.006725141328085094,
 'ACAd': 0.17180465030318343,
 'ILA': 0.09111137101408158,
 'ACAv': 0.13107151117231106,
 'ACB': 0.11774943042965409,
 'MT': 0.05789824962363264,
 'IMD': 0.08495213820556717,
 'PVHd': 0.00305299875521285,
 'ADP': 0.041978674435232705,
 'DT': 0.19155356649902924,
 'IO': 0.06663982691163553,
 'AHN': 0.06950997399080447,
 'IP': 0.059772473458188466,
 'DCO': 0.06092643095727272,
 'IPN': 0.08157473612201428,
 'VCO': 0.11911566280313302,
 'AId': 0.11498349781742877,
 'AIp': 0.13086027668911748,
 'AIv': 0.1558205708603141,
 'AM': 0.12453319020355953,
 'MRN': 0.04902699750873067,
 'LA': 0.17268818791849808,
 'AMB': 0.035985787321009606,
 'IRN': 0.08535565802434736,
 'PRNr': 0.04488401946840802,
 'LC': 0.01263451659128799,
 'PVT': 0.08266556876170478,
 'AOB': 0.2739399012762268,
 'LD': 0.11890534012346404,
 'AON': 0.33401805102113513,
 'LDT': 0.010988763833476864,
 'PRP': 0.09025740856437178,
 'LGd': 0.1738128157375418,
 'LGv': 0.2054122786852658,
 'RE': 0.0007023575790657893,
 'FRP': 0.2427384288771917,
 'LH': 0.1701659990920541,
 'RH': 0.00546260322594919,
 'LHA': 0.038737458390927466,
 'RL': 0.04847995046335108,
 'MV': 0.06469371087610348,
 'LIN': 0.08048285140133389,
 'LAV': 0.05702614462174153,
 'LM': 0.08887553525350972,
 'RN': 0.06588893332956923,
 'APN': 0.08185467149384805,
 'SUV': 0.03906992767352337,
 'LP': 0.14989057480970921,
 'RO': 0.1385453776266444,
 'SPIV': 0.07740305965024502,
 'LPO': 0.07560086829413076,
 'AT': 0.09201589180025029,
 'LRN': 0.06802037927636584,
 'RPO': 0.06213225604915883,
 'RR': 0.04654679840357231,
 'LSc': 0.02633293254892513,
 'AV': 0.13015725279209145,
 'LSr': 0.05895019033606331,
 'RT': 0.08813330380492687,
 'AVP': 0.06530876911258547,
 'LSv': 0.042765689464618784,
 'SAG': 0.03467743109176374,
 'SCm': 0.07600091624564431,
 'BLA': 0.1458537400514783,
 'MA': 0.1200706951666055,
 'SCs': 0.21944175530595128,
 'MARN': 0.05506702954108987,
 'SF': 0.07818552735179701,
 'BMA': 0.2152110337110713,
 'SubG': 0.26604831190974965,
 'SGN': 0.07114633400333358,
 'SSp-bfd': 0.23853239611620794,
 'SH': 0.03800860006070507,
 'SSp-ll': 0.17783026882598105,
 'SFO': 0.14187282924275477,
 'SI': 0.06823469986379642,
 'SSp-m': 0.28425328756313434,
 'BST': 0.02356773639339272,
 'SSp-n': 0.28086116803551164,
 'SSp-tr': 0.3759886945714783,
 'MD': 0.10275173536375613,
 'SMT': 0.07818685998771753,
 'SSp-ul': 0.13055323269711075,
 'ICB': 0.038477886631142565,
 'SNc': 0.06968286596681068,
 'SSs': 0.16774600239909535,
 'SNr': 0.09325448337007725,
 'CA1': 0.5945501503336061,
 'VISp': 0.38189063512901933,
 'VISam': 0.4018592258355554,
 'MDRN': 0.08515556390985793,
 'SOC': 0.10042913799088418,
 'VISal': 0.24038698110561904,
 'MEA': 0.1119828108669913,
 'SPF': 0.03609291254535857,
 'VISl': 0.348485894720944,
 'VISrl': 0.3658320917316429,
 'CA2': 0.437448179896965,
 'VISpl': 0.15014763326490715,
 'SPVC': 0.1446198127073732,
 'SPVI': 0.079930953093612,
 'SPVO': 0.10655016856967661,
 'MEPO': 0.1143357315519498,
 'CA3': 0.49031122835189933,
 'STN': 0.04833714800365587,
 'MG': 0.09420171864443573,
 'MH': 0.1633424122077867,
 'MM': 0.08260821865796666,
 'SUB': 0.273502188825275,
 'MOB': 0.8896218347485868,
 'MPN': 0.04778419761494408,
 'MPO': 0.03962333396399744,
 'SUM': 0.06613482803648546,
 'MPT': 0.20844528790167063,
 'VISpm': 0.43497186180168046,
 'SUT': 0.11226107459903002,
 'CEA': 0.10702622352781575,
 'TEa': 0.3045193132553028,
 'MS': 0.12005596603274696,
 'TR': 0.7986730336270217,
 'TRN': 0.04628128823108889,
 'CL': 0.16899949844961254,
 'NB': 0.1261826310897297,
 'TRS': 0.04626031675002363,
 'CLA': 0.1287997176214623,
 'CLI': 0.04209031191804945,
 'NDB': 0.13208429109234002,
 'TTd': 0.22234807059159503,
 'CM': 0.036798227640984844,
 'NI': 0.08562705985037422,
 'TTv': 0.35358133337120823,
 'SPA': 0.023949665172302525,
 'NLL': 0.06608847802398618,
 'TU': 0.16340432132914767,
 'CUN': 0.04929136208191398,
 'NLOT': 0.14538991261239953,
 'V': 0.21275435446093152,
 'NOT': 0.22943063305641975,
 'VAL': 0.05579495268821012,
 'NPC': 0.10474949688610329,
 'COAa': 0.24886642657009497,
 'COAp': 0.34484742458464274,
 'NTS': 0.1012910494969621,
 'VII': 0.0791081439309919,
 'CP': 0.08188610533586838,
 'VISC': 0.10393801512880774,
 'CS': 0.07798796992147208,
 'VM': 0.04023517750856584,
 'VLPO': 0.05865151623282062,
 'VMH': 0.18973112842875386,
 'OP': 0.19995024825896665,
 'CU': 0.1286654253279965,
 'VPL': 0.07914207938781043,
 'ORBl': 0.26563944985749854,
 'VPLpc': 0.046706422469317076,
 'DG': 1.0,
 'ORBm': 0.1860780460564819,
 'VPM': 0.07686182242988743,
 'VPMpc': 0.05622791908491866,
 'ORBvl': 0.16253277743711783,
 'VTA': 0.06332233499556283,
 'OT': 0.24589004269052409,
 'VTN': 0.08155536614201142,
 'x': 0.06005744712898496,
 'XII': 0.2637129960466888,
 'PA': 0.25681585701143883,
 'y': 0.03270283873077184,
 'PAA': 0.23529025657858937,
 'PAG': 0.043329815291401015,
 'ZI': 0.0600440740106245,
 'DP': 0.15944622898811608,
 'DMH': 0.060306182454573906,
 'DMX': 0.13589497519689842,
 'PAR': 0.26040249462430454,
 'DN': 0.056860360037311465,
 'PARN': 0.08418980032028853,
 'PAS': 0.16489360041928935,
 'PB': 0.04576265906222527,
 'DR': 0.04371935412280439,
 'PBG': 0.053995543501824686,
 'RSPd': 0.2916059075282766,
 'DTN': 0.04401931410281251,
 'RSPv': 0.30754961044071144,
 'RSPagl': 0.32808842904377117,
 'ECT': 0.256808001473381,
 'PCG': 0.03746114387271831,
 'ECU': 0.05888698364814813,
 'PCN': 0.10132327824461923,
 'LING': 0.05614462933988523,
 'ENTl': 0.26266023704904373,
 'PERI': 0.4519207930305946,
 'ENTm': 0.32955872391693963,
 'PF': 0.03540229151422452,
 'PG': 0.06766773341834148,
 'DEC': 0.10368237113805179,
 'PGRN': 0.06626867611797779,
 'FOTU': 0.11706433866861136,
 'PH': 0.05176889591523127,
 'PYR': 0.08874846724950783,
 'EPd': 0.2909682529300894,
 'UVU': 0.06439261698658404,
 'PIR': 0.32689190902375126,
 'EPv': 0.2476164374562108,
 'NOD': 0.07984158465841473,
 'PL': 0.13867148706796661,
 'EW': 0.040367576056249854,
 'CENT2': 0.09971964964066467,
 'FC': 0.2682784664329761,
 'CENT3': 0.11793251590147355,
 'MOp': 0.17720813826728923,
 'FN': 0.03956560978701849,
 'MOs': 0.2169000211526728,
 'root': 0.08534365261127377,
 'FS': 0.09966831977814652,
 'AUDp': 0.19946760025995752,
 'SIM': 0.10166439797090984,
 'AUDd': 0.1561462951347859,
 'AUDv': 0.1286391233032491,
 'PO': 0.06735591999251388,
 'GPe': 0.06988454989257377,
 'PRM': 0.14606403935156972,
 'AUDpo': 0.1992560384626782,
 'POL': 0.08169650865170035,
 'GPi': 0.05367509132209115,
 'COPY': 0.09919722129044863,
 'POST': 0.20797250608438894,
 'PFL': 0.1148219566263246,
 'PP': 0.16670257185289405,
 'GRN': 0.06430530595421145,
 'FL': 0.12431056986609755,
 'PPN': 0.02328814002543347,
 'ANcr1': 0.1327208702299598,
 'GU': 0.11000874454649434,
 'PPT': 0.19770772593921462,
 'ANcr2': 0.18069557633259647,
 'PR': 0.45649290321690705,
 'PRE': 0.20063945482565876,
 'CUL4 5': 0.10904943372032964,
 'PRNc': 0.04878423566520655,
 'IA': 0.13834421974137626,
 'PS': 0.09096326139028178,
 'IAD': 0.01933286492349705,
 'IAM': 0.0,
 'SSp-un': 0.31361279994463714,
 'VISa': 0.49473819812076125,
 'VISli': 0.2598203431432287,
 'VISpor': 0.1673367428940258,
 'ProS': 0.5062639557812698,
 'APr': 0.2082729102763706,
 'RPF': 0.06932456225101846,
 'MA3': 0.0808347140435102,
 'P5': 0.08777248678454766,
 'PC5': 0.1057332744401775,
 'I5': 0.2069774478841453,
 'Eth': 0.034406882620317596,
 'Xi': 0.016574729400385735,
 'PIL': 0.03133276041678539,
 'PoT': 0.04310402702118056,
 'IntG': 0.11888005511034021,
 'PeF': 0.034981400669322246,
 'HATA': 0.24979564787994865,
 'Pa5': 0.10155682853458736,
 'VeCB': 0.06335140750025031,
 'PDTg': 0.06406388843639664,
 'Pa4': 0.05444064389928336}
send2unity(values_dict)


## %%
import pandas as pd

from pathlib import Path
from one.remote import aws
from one.api import ONE
from ibllib.atlas import BrainRegions
regions = BrainRegions()
LOCAL_DATA_PATH = Path("/mnt/s0/aggregates/bwm")

df_clusters = pd.read_parquet(LOCAL_DATA_PATH.joinpath('clusters.pqt'))
df_probes = pd.read_parquet(LOCAL_DATA_PATH.joinpath('probes.pqt'))
df_channels = pd.read_parquet(LOCAL_DATA_PATH.joinpath('channels.pqt'))
df_depths = pd.read_parquet(LOCAL_DATA_PATH.joinpath('depths.pqt'))
df_voltage = pd.read_parquet(LOCAL_DATA_PATH.joinpath('raw_ephys_features.pqt'))

df_voltage = pd.merge(df_voltage, df_channels, left_index=True, right_index=True).dropna()
aids_cosmos = regions.remap(df_voltage['atlas_id'], source_map='Allen', target_map='Cosmos')
aids_beryl = regions.remap(df_voltage['atlas_id'], source_map='Allen', target_map='Beryl')
df_voltage['beryl_id'] = aids_beryl
df_voltage['cosmos_id'] = aids_cosmos


gb_regions = df_voltage.groupby('beryl_id')

df_regions = gb_regions.agg({
    'rms_ap': ('median', 'var'),
    'rms_lf': ('median', 'var'),
    'psd_gamma': 'median',
    'acronym': 'first',
    'x': 'count',
})

## %%

aids = df_regions.index.values
vals = df_regions['rms_lf']['median'].values.astype(np.float64)

vals = vals / np.sqrt(np.sum(vals**2))

vals = (vals - np.min(vals)) / (np.max(vals) - np.min(vals))



acronyms = regions.id2acronym(aids)

values_dict = {acronyms[i]: vals[i] for i, k in enumerate(acronyms)}
values_dict.pop('void')